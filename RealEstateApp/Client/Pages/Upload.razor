@page "/upload"

@using RealEstateApp.Shared.Models
@using RealEstateApp.Client.Services;
@inject RealEstateApp.Client.Services.AuthService AuthService
@inject RealEstateApp.Client.Services.ListingApiService ListingApiService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<head>
    <PageTitle>Upload a Listing</PageTitle>
    <link rel="stylesheet" href="css/global.css" />
    <script src="js/helper.js"></script>
</head>

<div class="topbar">
    <span class="brand"><a href="/">RealeCOM</a></span>
    <nav>
        <a href="/">Home</a>
        <a href="/upload">Upload a listing</a>
        <a href ="/login" class="login" >Sign in/Sign up</a>
    </nav>
</div>

<h3>You can upload a listing here</h3>


@if (!AuthService.IsAuthenticated)
{
    <div>
        <p>You must log in to upload a listing.</p>
        <button class="btn btn-primary" @onclick="GoToLogin">Go to Login</button>
    </div>
}
else
{
    <div class="editforma">
        <EditForm Model="@newListing" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Basic Info -->
            <div class="form-row">
                <label>Type</label>
                <InputSelect class="form-control" @bind-Value="newListing.Type">
                    <option value="" disabled selected hidden>-- Select Type --</option>
                    <option value="Apartment">Apartment</option>
                    <option value="House">House</option>
                </InputSelect>
            </div>

            <div class="form-row">
                <label>Area (mÂ²)</label>
                <input type="number" @ref="areaRef" class="form-control" @bind="newListing.Area" @onfocus="() => SelectInput(areaRef)" required />
            </div>

            <div class="form-row">
                <label>Price</label>
                <input type="number" class="form-control" @bind="newListing.Price" @ref="priceRef" @onfocus="() => SelectInput(priceRef)" required />
            </div>

            <div class="form-row">
                <label>Bedrooms</label>
                <input type="number" class="form-control" @bind="newListing.Bedrooms" @ref="bedroomsRef" @onfocus="() => SelectInput(bedroomsRef)" required />
            </div>

            <div class="form-row">
                <label>Bathrooms</label>
                <input type="number" class="form-control" @bind="newListing.Bathrooms" @ref="bathroomsRef" @onfocus="() => SelectInput(bathroomsRef)" required />
            </div>

            <div class="form-row">
                <label>Year Built</label>
                <input type="number" class="form-control" @bind="newListing.YearBuilt" @ref="yearBuiltRef" @onfocus="() => SelectInput(yearBuiltRef)" required />
            </div>

            <div class="form-row">
                <label>Heating Type</label>
                <InputText class="form-control" @bind-Value="newListing.HeatingType" required/>
            </div>

            <!-- Location -->
            <div class="form-row">
                <label>Country</label>
                <InputText class="form-control" @bind-Value="newListing.Country" required/>
            </div>

            <div class="form-row">
                <label>City</label>
                <InputText class="form-control" @bind-Value="newListing.City" required/>
            </div>

            <div class="form-row">
                <label>District</label>
                <InputText class="form-control" @bind-Value="newListing.District" required/>
            </div>

            <div class="form-row">
                <label>Address</label>
                <InputText class="form-control" @bind-Value="newListing.Address" required/>
            </div>

            <div class="form-row">
                <label>Zip Code</label>
                <InputText class="form-control" @bind-Value="newListing.ZipCode" required/>
            </div>

            <!-- Side Info -->
            <div class="Description">
                <label>Description</label>
                <InputTextArea class="form-control" @bind-Value="newListing.Description" required/>
            </div>

            <!-- Contact Info -->
            <div class="form-row">
                <label>Contact Name</label>
                <InputText class="form-control" @bind-Value="newListing.NameLastName" required/>
            </div>

            <div class="form-row">
                <label>Phone Number</label>
                <InputText class="form-control" @bind-Value="newListing.PhoneNumber" required/>
            </div>

            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Submit</button>

            @if (!string.IsNullOrEmpty(formError))
            {
                <div class="text-danger mt-2">@formError</div>
            }
        </EditForm>
    </div>
}



@code {
    private ListingDTO newListing = new ListingDTO();
    private bool isSubmitting;
    private string? formError;

    private async Task HandleValidSubmit()
    {
        formError = null;
        isSubmitting = true;

        try
        {
            // Call API to add the listing
            var created = await ListingApiService.AddListingAsync(newListing);

            // Redirect to listings page after successful upload
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            formError = $"Failed to upload listing: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
    void GoToLogin() => NavigationManager.NavigateTo("/login");

    ElementReference areaRef;
    ElementReference priceRef;
    ElementReference bedroomsRef;
    ElementReference bathroomsRef;
    ElementReference yearBuiltRef;

    private async Task SelectInput(ElementReference element)
    {
        await JS.InvokeVoidAsync("selectOnFocus", element);
    }
    protected override async Task OnInitializedAsync()
    {
        await AuthService.RestoreLoginAsync();
    }
}